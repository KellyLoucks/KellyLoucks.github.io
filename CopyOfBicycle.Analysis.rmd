---
title: "Bicycle.Analysis"
author: "Kelly Loucks, Sam Giardina, Tucker Southern"
date: "9/19/2017"
output: html_document
---

```{r, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
# For data manipulation and tidying
library(dplyr)
library(lubridate)
library(tidyr)

# For mapping
library(ggmap)
library(mapproj)

# For data visualizations
library(ggplot2)

# For modeling and machine learning
library(caret)

```

#Importing Data
```{r}
station <- read.csv(file = "station.csv", header = TRUE, 
                    stringsAsFactors = FALSE)

trip <- read.csv(file = "trip.csv", header = TRUE, 
                 stringsAsFactors = FALSE)

weather <- read.csv(file = "weather.csv", header = TRUE, 
                    stringsAsFactors = FALSE)

```

#Data Structures and Variables
```{r}
str(station)
str(trip)
str(weather)
```


#Data Visualizations
##Exploring the Stations Dataset
```{r, message=FALSE}
station %>% summarise(n_distinct(station_id))
station_locs <- station %>% group_by(station_id) %>% select(1:4, -2)
# Load the correct map
mymap <- get_map(location = "Seattle", maptype = "roadmap", zoom = 12)

# Plot a single point for each Station ID
ggmap(mymap) + geom_point(aes(x = long, y = lat), data = station_locs, 
                          alpha = 0.7, color = "darkred", size = 2)

```

#Station Installations
```{r}

station$install_date <- mdy(station$install_date)

# How many times were new stations installed?
station %>% summarise(n_distinct(install_date))

# How many stations were installed on each date?
station %>% group_by(install_date) %>% summarise(count = n()) %>% 
    arrange(install_date)
```


```{r,echo=FALSE}
# Plot a single point for each Station ID
ggmap(mymap) + geom_point(aes(x = long, y = lat), data = station_locs, 
                          alpha = 0.7, color = "darkred", size = 2)
```

Some text

```{r, echo = FALSE}
ggmap(mymap) + geom_point(aes(x = long, y = lat, color = factor(install_date)), data = subset(station, install_date != "2014-10-13"), alpha = 0.7, size = 2)

```




```{r}
dock_change <- station %>% group_by(station_id) %>% select(station_id, 
    long, lat, ends_with("dockcount")) %>% mutate(dock_change = current_dockcount - 
    install_dockcount)

```

##Change in Number of Bike Docks Per Station

#Current Station Size

#Exploring the trips dataset

```{r}
glimpse(trip)

# Make the start and stop dates into POSIXct objects
trip_2 <- trip %>% mutate(start_dt = mdy_hm(starttime), stop_dt = mdy_hm(stoptime))

# Recode the dates
trip_2 <- trip_2 %>% mutate(start_date = paste(month(start_dt), 
    day(start_dt), year(start_dt), sep = "/"))
trip_2$start_date <- mdy(trip_2$start_date)

trip_2 <- trip_2 %>% mutate(stop_date = paste(month(stop_dt), 
    day(stop_dt), year(stop_dt), sep = "/"))
trip_2$stop_date <- mdy(trip_2$stop_date)


```

```{r}
trip_2 %>% 
  group_by(start_date) %>%
  summarize(N = n()) %>%
  ggplot(aes(x = start_date, y = N)) + 
  geom_line() + 
  labs(x = "Date", y = "Number of trips per day") + 
  theme_bw()+ geom_smooth()


```

#Plotting trips per month by season
```{r}
start_date_ym <- trip_2 %>% mutate(ym = paste(year(start_date), 
    month(start_date), sep = "/"), Season= ifelse(ym %in% c("2014/10", "2014/11"), "Fall",
                                           ifelse(ym  %in% c("2014/12", "2015/1", "2015/2"), "Winter",
                                           ifelse(ym %in% c("2015/3", "2015/4", "2015/5"), "Spring", "Summer"))))


```
#Now plot. I think I’ll plot this by month but color it by season (where December, January, and February are “winter”, March, April, and May are “spring”, June, July, August are “summer”, and September, October, November are “autumn”)




```{r}
start_date_ym %>% 
  group_by(ym, Season) %>%
  summarize(N = n()) %>%
  ggplot(aes(x = ym, y = N, col = Season)) + 
  geom_point() +
  geom_line(group = 1) + 
  theme_bw()+
  labs(x = "Date", y = "Number of Trips (Per Month)") 
```

#Average trip duration
Great! I wonder how the average trip duration fluctuates over this time period.
```{r}
# Convert Trip Duration from Seconds to Minutes
Trip_Duration_Month <- start_date_ym %>% mutate(trip_duration_min = tripduration/60) %>% 
    group_by(ym) %>% select(ym, trip_duration_min) %>% summarise(Avg = mean(trip_duration_min), 
    sd = sd(trip_duration_min)) %>% mutate(se = sd/sqrt(n()), Season= ifelse(ym %in% c("2014/10", "2014/11"), "Fall",
                                           ifelse(ym  %in% c("2014/12", "2015/1", "2015/2"), "Winter",
                                           ifelse(ym %in% c("2015/3", "2015/4", "2015/5"), "Spring", "Summer"))))
```
Now to plot the average trip duration (in minutes) (plus or minus standard error), with colors indicating season.

```{r, fig.align='center'}
ggplot(Trip_Duration_Month, aes(x = ym, y = Avg, col= Season)) + 
  geom_point() +
  geom_line(aes(group = 1)) + 
  geom_errorbar(aes(ymin=Avg-se, ymax=Avg+se))+
  theme_bw()+
  labs(x = "Date", y = "Duration of Average Trip (minutes)") 
```
There’s surprisingly not a huge range in trip durations here.


The little bit of variation here makes logical sense. Longer trips were being taken in the spring and summer months rather than the fall and winter. It’s also notable that the spring and summer of 2016 may have shown fewer trips than the previous year, show a slight increase in average trip length.

#Number of trips by day of week
```{r}
trip_2$wd <- wday(trip_2$start_date, label = TRUE)
```

```{r}
start_date_ym$wd <- wday(start_date_ym$start_date, label = TRUE)
```

```{r}
start_date_ym %>%
  group_by(Season, wd) %>%
  summarize(N = n()) %>%
  ggplot(aes(x = wd, y = N, col = Season, fill=Season, group=Season)) +
  geom_point() +
  geom_line() +
  theme_bw()+
  labs(x = "Day of the Week", y = "Number of Trips")


```
So it looks like usage is relatively consistent across seasons, at least as far as the number of trips are concerned.
##Number of Trips by Time of Day
How about time of day? Are people using these around commuting times during the week and later on weekends?

```{r}
start_date_ym %>%
  group_by(Season, wd) %>%
  summarize(N = n()) %>%
  ggplot(aes(x = wd, y = N, col = Season, fill=Season, group=Season)) +
  geom_point() +
  geom_line() +
  theme_bw()+
  labs(x = "Number of Trips", y = "Hour of Day")+
  facet_grid(.~wd)


```




#Member Demographics
We only seem to have age and gender information about people who have an annual Pronto! membership, so we can at least take a look at what types of people use this service.

Let’s look first at age.
```{r}
trip_2$usertype <- as.factor(trip_2$usertype)
trip_age <- trip_2 %>% mutate(age = year(start_dt) - birthyear)

hist(trip_age$age, main = "Member Age", xlab = "Number of Riders", 
    col = "#56B4E9", breaks = 25)
```






#Trip Routes
```{r}
# Create a dataframe with only station ID, latitude, and
# longitude
station_coord <- station %>% select(station_id, lat, long)

# Trim our trip dataframe to only include start & stop
# dates/times, and station ID
trip_route <- trip_2 %>% select(trip_id, starts_with("start_"), 
    starts_with("stop_"), from_station_id, to_station_id, tripduration)

# Match by station ID
trip_route$start_lat <- station_coord[match(trip_route$from_station_id, 
    station_coord$station_id), "lat"]

trip_route$start_long <- station_coord[match(trip_route$from_station_id, 
    station_coord$station_id), "long"]

trip_route$stop_lat <- station_coord[match(trip_route$to_station_id, 
    station_coord$station_id), "lat"]

trip_route$stop_long <- station_coord[match(trip_route$to_station_id, 
    station_coord$station_id), "long"]


```


#Exploring the weather data set
```{r}
glimpse(weather)


```

#Great, let’s change the Date variable to a POSIXct object, and make the “Events” variable factors.
```{r}
# Adjusting the Date Variable
weather$Date <- mdy(weather$Date)

# Adjusting the Events Variable
weather$Events <- as.factor(weather$Events)


```
#Great. Now how many weather events are there?
```{r}
levels(weather$Events)

```
#wow, so many combinations of rain!
#let's combine a few things that seem to represent the same event 

```{r}
weather$Events <- gsub("Fog , Rain|Fog-Rain", "Fog-Rain", weather$Events)
weather$Events <- gsub("Rain , Snow|Rain-Snow", "Rain-Snow", 
    weather$Events)
weather$Events <- gsub("Rain , Thunderstorm|Rain-Thunderstorm", 
    "Rain-TS", weather$Events)

weather$Events <- as.factor(weather$Events)


```
#look for missing values
```{r}
summary(weather)
```
Ok, so we have one NA for “Mean_Temperature_F”, “Max_Gust_Speed_MPH” seems to be represented as a character vector because it has “-” representing NA values, and we have 361 unlabelled Events.

Max Gust Speed should be the easiest one to fix, so we’ll start there.

```{r}
weather$Max_Gust_Speed_MPH <- gsub("-", 0, weather$Max_Gust_Speed_MPH)

weather$Max_Gust_Speed_MPH <- as.numeric(weather$Max_Gust_Speed_MPH)

```

Great! We changed any absent values for Maximum Gust Speed to 0 MPH and changed the variable type to a number. Uh oh, looks like there are still 185 NA values for Max Gust Speed. That’s a lot to try to replace. I would normally suggest generating a model that could try to predict those values based on other known values, but for now, we’ll just leave it alone.

Since there is only one missing Mean Temperature, it seems the easiest way to fill in the hole is to look up what the average temperature was that day. Note: I certainly would not recommend this if it were any more than one missing value

```{r}
weather[which(is.na(weather$Mean_Temperature_F)), 1]

```
Ok, so we’re looking for the Mean Temperature on February 14, 2016 in the zipcode 98101 (according to dataset documentation). Looks like the mean temperature that day was 50 degrees F.

Time to substitute in that value.

```{r}
weather[490, "Mean_Temperature_F"] <- "50"
```


Perfect. Now what to do with the unlabelled “Event” categories. The dataset “ReadMe” file from Pronto! doesn’t include any information about this weather dataset. The only thing I can think to do is refer to the Event as “Other”.


```{r}
weather$Events <- gsub("^$", "Other", weather$Events)
weather$Events <- as.factor(weather$Events)

```

Ok, we’re in good shape. Now to do a few quick visualizations.
##Temperature
Minimum
```{r}


```
Mean
```{r}


```
Maximum
```{r}


```
Events
```{r}

```
#Combining Weather and Trip Datasets
Good, so we can now see some parts of the weather data. Let’s combine the weather data with our trip data. Let’s try a  left join from the dplyr package.
```{r}
# Make a copy of the data frame
trip_3 <- trip_2

# Change column name in trip_3 to match weather dataset
trip_3$Date <- trip_3$start_date

# Left join the trip and weather dataframes by date.
trip_weather <- left_join(trip_3, weather, by = "Date")

```
#Mean Temperature vs. Number of Trips
Ok. Now let’s see how the number of trips per day is influenced by weather (mean temperature, rounded to the nearest 5 degrees F)

